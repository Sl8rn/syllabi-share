{% extends 'base.html' %}
{% block content %}
<form id="form-id" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <h1 class='text-center'> Upload Syllabus: </h1>
  <div style="width: 35%; margin: auto; display: block;">
    <div class="form-group group">
      <h4 for="prof"> <b>Professor:</b> </h4>
      <input style="width:100%;" id="prof" type="text" name="prof" required> <br>
    </div>
    <div class="form-group group">
      <h4 for="prof"> <b>Course:</b> </h4>
      <input style="width:100%;" id="course" type="text" name="course" required> <br>
    </div>
    <div class="form-group group">
      <h4 for="prof"> <b>Syllabus:</b> </h4>
      <input style="width:100%;" id="file" type="file" name="file" accept="application/pdf" required> <br>
    </div>
  </div>
  <input class="btn btn-success" style="display: block; margin: auto;" type="submit" value="Submit"> <br> 
  {% if success %}
  {% else %}
  <div class="alert alert-danger text-center" style="width: 30%; margin: auto;" role="alert"> Misuse of uploads will be met by a ban! </div>
  {% endif %}
</form>
<script type="text/javascript">
  function uploadFile(file, s3Data, url){
    var xhr = new XMLHttpRequest();
    xhr.open("POST", s3Data.url);
  
    var postData = new FormData();
    for(key in s3Data.fields){
      postData.append(key, s3Data.fields[key]);
    }
    postData.append('file', file);
  
    xhr.onreadystatechange = function() {
      if(xhr.readyState === 4){
        if(xhr.status === 200 || xhr.status === 204){
          document.getElementById("preview").src = url;
          document.getElementById("avatar-url").value = url;
        }
        else{
          alert("Could not upload file.");
        }
     }
    };
    xhr.send(postData);
  }

  function getSignedRequest(file){
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/sign_s3?file_name="+file.name+"&file_type="+file.type);
    xhr.onreadystatechange = function(){
      if(xhr.readyState === 4){
        if(xhr.status === 200){
          var response = JSON.parse(xhr.responseText);
          uploadFile(file, response.data, response.url);
        }
        else{
          alert("Could not get signed URL.");
        }
      }
    };
    xhr.send();
  }

  $(function(){
      $("#file").on('change', function(event) {
          var file = event.target.files[0];
          if(file.size>=2*1024*1024) {
              alert("Upload PDFs of size less than 2MB please");
              $("#form-id").get(0).reset(); 
              return;
          }
  
          if(!file.type.match('application/pdf.*')) {
              alert("Upload PDFs only please!");
              window.location.assign($(location).attr('href'));
              return;
          }
          document.getElementById("file_input").onchange = function(){
          var files = document.getElementById("file_input").files;
          var file = files[0];
          if(!file){
            return alert("No file selected.");
          }
          getSignedRequest(file);
        };
      });
  });
</script>
{% endblock %}